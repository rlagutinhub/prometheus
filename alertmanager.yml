# amtool alert add --alertmanager.url http://localhost:9093 alertname=alertname_test host=host_test instance=instance_test

global:
  resolve_timeout: 5m # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–∞ –æ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º

route:
  group_by: ['alertname', 'instance'] # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –ø–æ alertname –∏ instance
  group_wait: 30s # –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–µ—Ä–≤–æ–π –≥—Ä—É–ø–ø—ã –∞–ª–µ—Ä—Ç–æ–≤
  group_interval: 5m # –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤ –∏–∑ —ç—Ç–æ–π –∂–µ –≥—Ä—É–ø–ø—ã
  repeat_interval: 1h # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
  receiver: default # –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

  routes:

    - receiver: 'telegram'
      match:
        severity: 'critical'
      repeat_interval: 10m
      continue: false  # –ï—Å–ª–∏ –∞–ª–µ—Ä—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É, –µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–ª—å—à–µ

    - receiver: 'telegram'
      # match_re:
      #   severity: 'critical|warning'
      continue: true # –ê–ª–µ—Ä—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ –¥—Ä—É–≥–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã

    # - receiver: 'mail'
    #   #  match_re:
    #   #    severity: 'critical'
    #   continue: true # –ê–ª–µ—Ä—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ –¥—Ä—É–≥–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã

receivers:

  - name: 'default' # –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∑–∞–≥–ª—É—à–∫–∞

  - name: 'telegram'
    telegram_configs:
      - bot_token: 'XXX'
        api_url: 'https://api.telegram.org'
        chat_id: XXX
        parse_mode: 'MarkdownV2'
        disable_notifications: false
        send_resolved: true
        # message: |
        #   {{ if gt (len .Alerts.Firing) 0 }}
        #   üî• Firing:
        #   {{ template "__text_alert_list" .Alerts.Firing }}
        #   {{ end }}
        #   {{ if gt (len .Alerts.Resolved) 0 }}
        #   ‚úÖ Resolved:
        #   {{ template "__text_alert_list" .Alerts.Resolved }}
        #   {{ end }}
        # message: |
        #   *{{ .Status | title }}:* *{{ .CommonLabels.alertname }}* {{ if eq .Status "firing" }}üî•{{ else }}‚úÖ{{ end }}

        #   *Severity:* `{{ .CommonLabels.severity }}`
        #   *Instance:* `{{ .CommonLabels.instance }}`
        #   *Summary:* {{ .CommonAnnotations.summary }}
        #   *Description:* {{ .CommonAnnotations.description }}

        #   *Details:*
        #   {{- range .Alerts }}
        #   *Starts at:* {{ .StartsAt | date "2006-01-02 15:04:05 MST" }}
        #   *Ends at:* {{ if .EndsAt.IsZero }}N/A{{ else }}{{ .EndsAt | date "2006-01-02 15:04:05 MST" }}{{ end }}

        #   *Labels:*  
        #   {{- range .Labels.SortedPairs }}
        #   `{{ .Name }}: {{ .Value }}`
        #   {{- end }}

        #   *Annotations:*  
        #   {{- range .Annotations.SortedPairs }}
        #   `{{ .Name }}: {{ .Value }}`
        #   {{- end }}
        #   {{- end }}
        message: |
          {{- if eq .Status "firing" -}}
              {{- if eq .CommonLabels.severity "critical" -}}
                  üî¥ Alert: {{ .CommonLabels.alertname }}
              {{- else if eq .CommonLabels.severity "warning" -}}
                  üü† Alert: {{ .CommonLabels.alertname }}
              {{- else -}}
                  ‚ö™Ô∏è Alert: {{ .CommonLabels.alertname }}
              {{- end }}
          Status: üî• FIRING
          Severity: {{ if eq .CommonLabels.severity "critical" }}üî¥ {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}üü† {{ .CommonLabels.severity | title }}{{ else }}‚ö™Ô∏è {{ .CommonLabels.severity | title }}{{ end }}
          {{- else if eq .Status "resolved" -}}
              ‚ö™Ô∏è Alert: {{ .CommonLabels.alertname }}
          Status: ‚úÖ RESOLVED
          Severity: {{ if eq .CommonLabels.severity "critical" }}üü¢ {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}üü¢ {{ .CommonLabels.severity | title }}{{ else }}‚ö™Ô∏è {{ .CommonLabels.severity | title }}{{ end }}
          {{- end }}

          {{- range .Alerts -}}

          {{- if .Labels.job }}
          Job: `{{ .Labels.job }}`
          {{- end }}

          {{- if .Labels.namespace }}
          Namespace: `{{ .Labels.namespace }}`
          {{- end }}

          {{- if .Labels.instance }}
          Instance: `{{ .Labels.instance }}`
          {{- end }}

          {{- if .Annotations.runbook_url }}
          [RunbookURL]({{ .Annotations.runbook_url }})

          {{- end }}
          {{- end }}

  # - name: 'mail'
  #   email_configs:
  #     - smarthost: mail.example.ru:25
  #       hello: mail.example.ru
  #       to: 'root@servers.ru'
  #       from: 'alert@example.ru'
  #       auth_username: 'alert@example.ru'
  #       auth_password: '123456'
  #       require_tls: true
